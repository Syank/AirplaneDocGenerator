import { faLongArrowAltLeft, faLongArrowAltRight, faSearch } from "@fortawesome/free-solid-svg-icons";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import React from "react";
import Button from "../assets/components/Button";
import CardHeader from "../assets/components/CardHeader";
import { notification } from "../assets/components/Notifications";
import SelectProjectItem from "../assets/components/SelectProjectItem";
import { getBackgroundImage } from "../utils/pagesUtils";
import ServerRequester from "../utils/ServerRequester";



/**
 * Classe de componente que representa a tela de listagem e sele칞칚o de manuais no sistema
 *
 * @author Rafael Furtado
 */
class SelectProjectScreen extends React.Component {
    constructor(props) {
        super(props);

        this.headerCardTitle = "Gerir documento";
        this.headerCardText = "Escolha um manual na lista para editar sua composi칞칚o ou exclu칤-lo da plataforma";

        this.state = {
            selectedProject: {
                nome: "Selecione um manual",
                descricao: "Selecione um manual na lista para ver mais detalhes e informa칞칫es sobre ele aqui"
            },
            projectsList: [[]],
            searchList: [[]],
            originalProjectsList: [[]],
            page: 1,
            search: ""
        }

        this.setSelectedItem = this.setSelectedItem.bind(this);
        this.deleteProject = this.deleteProject.bind(this);
        this.nextPage = this.nextPage.bind(this);
        this.previousPage = this.previousPage.bind(this);
        this.search = this.search.bind(this);
        this.goToProjectView = this.goToProjectView.bind(this);

    }

    /**
     * Fun칞칚o do ciclo de vida dos componentes do React, ser치 chamado apenas uma vez, quando o
     * componente for renderizado na tela
     * 
     * @author Rafael Furtado
     */
    async componentDidMount(){
        let projects = await this.getProjecsList();

        let projectsList = [];

        let projectsByPage = [];

        for (let i = 0; i < projects.length; i++) {
            const project = projects[i];
            
            if(projectsByPage.length < 5){
                projectsByPage.push(project);

            }else{
                projectsList.push(projectsByPage);

                projectsByPage = [project];

            }

        }

        if(projectsByPage.length > 0){
            projectsList.push(projectsByPage);

        }
        
        this.setState({projectsList: projectsList, originalProjectsList: projects});

    }

    /**
     * Faz uma requisi칞칚o ao servidor para obter a lista de todos os projetos
     * 
     * @returns Retorna a lista de projetos no sistema
     * @author Rafael Furtado
     */
    async getProjecsList(){
        let serverRequester = new ServerRequester("http://localhost:8080");

        let response = await serverRequester.doGet("/project/all");

        let projectsList = []

        if(response["responseJson"] === false){
            notification("error", "Algo deu errado 游뗴", "N칚o foi poss칤vel carregar a lista de projetos");

            return projectsList;
        }

        projectsList = response["responseJson"];

        return projectsList;
    }

    /**
     * Constr칩i adequadamente o componente do cabe칞alho de t칤tulo da p치gina
     *
     * @returns Retorna o cabe칞alho de t칤tulo da p치gina
     * @author Carolina Margiotti
     */
    getHeaderCard() {
        let headerCard = (
            <CardHeader
                title={this.headerCardTitle}
                description={this.headerCardText}
            ></CardHeader>
        );

        return headerCard;
    }

    /**
     * Constr칩i adequadamente o componente que representa a p치gina de exibi칞칚o da lista de manuais
     *
     * @returns Retorna o componente que representa a p치gina de exibi칞칚o da lista de manuais
     * @author Carolina Margiotti
     */
    getSelectProjectScreen() {
        let selectProjectScreen = (
            <div id="contentDisplay" className="w-full h-full">
                {getBackgroundImage()}

                <div
                    id="selectProjectScreen"
                    className="w-full h-full flex flex-col items-center justify-center relative select-none"
                >
                    <div className="w-full h-2/4 flex flex-row justify-center items-start">
                        {this.getHeaderCard()}
                    </div>
                    <div className="w-full h-full flex flex-row items-center justify-evenly">
                        {this.getSelectContainer()}
                    </div>
                </div>
            </div>
        );

        return selectProjectScreen;
    }

    /**
     * Constr칩i a se칞칚o onde ser치 exibido a lista de manuais e suas informa칞칫es
     * 
     * @returns Retorna o container onde ser치 exibido a lista de manuais no sistema
     * @author Rafael Furtado
     */
    getSelectContainer(){
        let container = (
            <div className="text-xl w-selectProjectW h-selectProjectH bg-white flex flex-row items-center px-6 py-2 shadow-2xl">
                {this.getListSide()}
                <div className="bg-gray-400 h-full mt-8 mb-8 w-1"></div>
                {this.getInformationSide()}
            </div>
        );

        return container;
    }

    /**
     * Constr칩i a lista em si de onde os manuais ser칚o exibidos para serem selecionados
     * 
     * @returns Retorna o lado do container de manuais onde est치 a lista de manuais
     * @author Rafael Furtado
     */
    getListSide(){
        let container = (
            <div className="w-full h-full flex flex-col justify-between pr-5">
                <div className="mb-5 border-b-2 border-gray-400 h-10 w-full flex flex-row items-center justify-center">
                    <label>Manuais na plataforma</label>
                </div>
                <div className="w-full h-full">
                    {this.populateList()}
                </div>
                <div className="h-12 w-full flex flex-row justify-between pt-3 pl-2 pr-2">
                    <FontAwesomeIcon
                        className="cursor-pointer"
                        icon={faLongArrowAltLeft}
                        onClick={this.previousPage}
                    />

                    {this.getPaginationElement()}

                    <FontAwesomeIcon
                        className="cursor-pointer"
                        icon={faLongArrowAltRight}
                        onClick={this.nextPage}
                    />
                </div>
            </div>
        );

        return container;
    }

    /**
     * Retorna para a p치gina anterior na lista de sele칞칚o de manuais
     * 
     * @author Rafael Furtado
     */
    previousPage(){
        let actualPage = this.state["page"];
        
        if(actualPage > 1){
            this.setState({page: actualPage - 1});

        }
    }

    /**
     * Avan칞a para a pr칩xima p치gina na lista de sele칞칚o de manuais
     * 
     * @author Rafael Furtado
     */
    nextPage(){
        let actualPage = this.state["page"];
        let maxPage = this.state["projectsList"].length;
        
        if(actualPage < maxPage){
            this.setState({page: actualPage + 1});

        }

    }

    /**
     * Realiza a busca de manuais de acordo com o texto escrito no input de busca
     * 
     * Ap칩s a busca, o componente ser치 renderizado novamente para exibir o resultado
     */
    search(){
        let searchInput = document.getElementById("projectSearch");

        let valueToSearch = searchInput.value;

        let searchList = this.getSearchList(valueToSearch);

        if (searchList.length == 0){
            notification("error", "Algo deu errado 游뗴", "Nenhum projeto encontrado para essa pesquisa");
        
            return searchList;
        }
        else{
            this.setState({search: valueToSearch, projectsList: searchList, page: 1});
        }
    }

    /**
     * Utilizando o texto de busca, filtra a lista de manuais a serem exibidos
     * 
     * @param {String} valueToSearch Valor digitado no input de pesquisa
     * @returns Retorna uma nova lista de manuais a serem exibidos de acordo com o par칙metro de busca
     * @author Rafael Furtado
     */
    getSearchList(valueToSearch){
        let projectsList = [];

        let projectsByPage = [];

        let originalList = this.state["originalProjectsList"];

        for (let i = 0; i < originalList.length; i++) {
            const project = originalList[i];
            const projectName = project["nome"];

            if (valueToSearch !== "" && !projectName.includes(valueToSearch.toUpperCase())) {
                continue;
            }

            if (projectsByPage.length < 5) {
                projectsByPage.push(project);

            } else {
                projectsList.push(projectsByPage);

                projectsByPage = [project];

            }

        }

        if (projectsByPage.length > 0) {
            projectsList.push(projectsByPage);

        }

        return projectsList;
    }

    /**
     * Constr칩i o lado do compononte onde estar치 dispon칤vel dados e utilidades para gerir a lista de manuais
     * 
     * @returns Retorna o lado do container de manuais no qual ser치 exibido os campos de busca e informa칞칫es
     * @author Rafael Furtado
     */
    getInformationSide(){
        let container = (
            <div className=" w-full h-full flex flex-col items-center justify-between pt-5 pb-5">
                <div>
                    <input id="projectSearch" type="text" placeholder="Pesquisar por nome" className="text-center outline-none border-b-2 mr-2"></input>
                    <FontAwesomeIcon onClick={this.search} icon={faSearch} className="cursor-pointer"></FontAwesomeIcon>
                </div>
                <div className="w-full h-full mt-5 mb-5 flex flex-col items-center text-center">
                    <label>{this.state["selectedProject"]["nome"]}</label>
                    <p className="mt-5 text-sm">{this.state["selectedProject"]["descricao"]}</p>
                </div>
                <Button text="Selecionar" type="confirm" onClick={this.goToProjectView}></Button>
            </div>
        );

        return container;
    }

    /**
     * Vai para a p치gina de edi칞칚o/gerenciamento do manual selecionado
     * 
     * @author Rafael Furtado
     */
    goToProjectView(){
        let projectName = this.state["selectedProject"]["nome"];
        
        if(projectName !== "Selecione um manual"){
            window.sessionStorage.setItem("selectedProject", projectName);

            this.props.navigation("projectAdministration");

        }else{
            notification("info", "Um momento! 游땔", "Selecione um projeto antes de navegar para sua p치gina de administra칞칚o");
            
        }

    }

    /**
     * Constr칩i o componente de rodap칠 onde exibi a quantia de p치ginas de manuais que podem ser vistos
     * 
     * @returns Retorna o componente que serve de p치gina칞칚o da lista de manuais
     * @author Rafael Furtado
     */
    getPaginationElement(){
        let maxPage = this.state["projectsList"].length;

        let pagination = (
            <label className="text-sm">P치gina {this.state["page"]} de {maxPage}</label>
        );

        return pagination;
    }

    /**
     * Atrav칠s da vari치vel de estado "page", define quais ser칚o os manuais que dever칚o ser exibidos para a p치gina
     * 
     * @returns Retorna a lista de manuais que ser칚o exibidas para a p치gina em quest칚o
     */
    getProjectsToShow() {
        let page = this.state["page"] - 1;

        let projectsToShow = this.state["projectsList"][page];

        if (projectsToShow === undefined) {
            projectsToShow = [];

        }

        return projectsToShow;
    }

    /**
     * Constr칩i os componentes no qual o usu치rio pode interagir e ver qual manual representa
     * 
     * @returns Retorna os componentes que representam os manuais a serem exibidos na lista
     * @author Rafael Furtado
     */
    populateList(){
        let projects = [];

        let projectsToShow = this.getProjectsToShow();

        for (let i = 0; i < projectsToShow.length; i++) {
            const projectData = projectsToShow[i];

            const projectName = projectData["nome"];
    
            let element = (
                <SelectProjectItem key={projectName} 
                                   projectName={projectName} 
                                   setSelectedItem={this.setSelectedItem} 
                                   deleteProject={this.deleteProject}>
                </SelectProjectItem>
            );

            projects.push(element);

        }

        return projects;
    }

    /**
     * Seleciona o manual em raz칚o de seu nome, para exibir mais informa칞칫es sobre ele
     * 
     * @param {String} name Nome do manual a ser selecionado
     * @author Rafael Furtado
     */
    setSelectedItem(name){
        let project = this.getProjectDataByName(name);

        this.setState({selectedProject: project});

    }

    /**
     * Deleta o manual do sistema
     * 
     * @param {String} name Nome do manual a ser deletado
     * @author Rafael Furtado
     */
    deleteProject(name){
        notification("info", "Um momento! 游뱂", "Este recurso ainda n칚o est치 dispon칤vel no momento")

    }

    /**
     * Atrav칠s do nome, retorna as informa칞칫es do manual a serem exibidas ao usu치rio
     * 
     * @param {String} name Nome do manual a ter as informa칞칫es acessadas
     * @returns Retorna as informa칞칫es do manual requisitado
     * @author Rafael Furtado
     */
    getProjectDataByName(name){
        let projectsLists = this.state["projectsList"];

        for (let i = 0; i < projectsLists.length; i++) {
            const list = projectsLists[i];
            
            for (let x = 0; x < list.length; x++) {
                const project = list[x];
                
                if(project["nome"] === name){
                    return project;
                }

            }

        }

    }

    /**
     * M칠todo obrigat칩rio herdado da classe React.Component
     *
     * Renderiza a p치gina inicial da aplica칞칚o
     *
     * @returns Retorna o elemento a ser renderizado na janela
     * @author Carolina Margiotti
     */
    render() {
        let selectProjectScreen = this.getSelectProjectScreen();

        return selectProjectScreen;
    }

}

export default SelectProjectScreen;